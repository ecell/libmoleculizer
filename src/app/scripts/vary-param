#!/bin/bash
###############################################################################
# Moleculizer - a stochastic simulator for cellular chemistry.
# Copyright (C) 2001  Walter Lawrence (Larry) Lok.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#    
# Contact information:
#   Larry Lok, Research Fellow          Voice: 510-981-8740
#   The Molecular Sciences Institute      Fax: 510-647-0699
#   2168 Shattuck Ave.                  Email: lok@molsci.org
#   Berkeley, CA 94704
###############################################################################

# This script reaches into an XML file to change the value at a location given
# by an XPATH.

# Construct the XSLT tranformation that does the parameter substitution, the
# hard way.  It is necessary to generate the XSLT file because parameters
# cannot be used in "match" values in XSLT templates. 

# The "XSLT cookbook" admits that generating the XSLT transformation is the
# best way to do this, citing this as an example of a reason one might want to
# use an XSLT to generate XSLT.

# Note that the XSLT transformation used in the website for general web-based
# parameter editing is also generated by the Perl script (mzr-dispatch).

SOURCE_FILE="$1"
TARGET_XPATH="$2"
NEW_VALUE="$3"
DESTINATION_FILE="$4"

TMP_XSLT="/tmp/varsubst-tmp-$$"

echo -n '<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"><xsl:template match="node() | @*"><xsl:copy><xsl:apply-templates select="@* | node()"/></xsl:copy></xsl:template><xsl:template match="' > $TMP_XSLT

echo -n "$TARGET_XPATH" >> $TMP_XSLT

echo -n '"><xsl:attribute name="{name()}"><xsl:value-of select="' >> $TMP_XSLT

echo -n "$NEW_VALUE" >> $TMP_XSLT

echo -n '"/></xsl:attribute></xsl:template></xsl:stylesheet>' >> $TMP_XSLT

java org.apache.xalan.xslt.Process \
-in $SOURCE_FILE \
-xsl $TMP_XSLT \
-xml \
-out $DESTINATION_FILE

rm $TMP_XSLT
